<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Matcher - ATS Optimizer</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        :root { --primary: #0070f3; --bg: #f4f7f6; --text: #1e293b; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
        .container { max-width: 850px; margin: 0 auto; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        h1 { text-align: center; color: #0f172a; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: #64748b; margin-bottom: 2rem; }
        textarea { width: 100%; height: 160px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 10px; box-sizing: border-box; font-family: inherit; resize: vertical; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 1rem; transition: background 0.2s; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .result-card { border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-top: 1.5rem; border-left: 6px solid var(--primary); }
        .score { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; margin: 4px; font-weight: 600; }
        .tag-match { background: #dcfce7; color: #166534; }
        .tag-missing { background: #fee2e2; color: #991b1b; }
        .error-box { background: #fff5f5; color: #c53030; padding: 15px; border-radius: 8px; border: 1px solid #feb2b2; margin-top: 20px; }
        .file-list { margin-top: 10px; font-size: 0.9rem; color: #475569; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [jd, setJd] = useState('');
            const [resumes, setResumes] = useState([]);
            const [loading, setLoading] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);

            const extractText = async (file) => {
                try {
                    if (file.type === "application/pdf") {
                        const pdfjsLib = window['pdfjs-dist/build/pdf'];
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let text = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + " ";
                        }
                        return text;
                    } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        return result.value;
                    }
                    return "Unsupported file type";
                } catch (e) {
                    console.error("Extraction error:", e);
                    return "Error reading file content";
                }
            };

            const handleFiles = async (e) => {
                const files = Array.from(e.target.files);
                setLoading(true);
                const data = await Promise.all(files.map(async f => ({
                    name: f.name,
                    content: await extractText(f)
                })));
                setResumes(data);
                setLoading(false);
            };

            const runAnalysis = async () => {
                setLoading(true);
                setError(null);
                setResults(null);
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resumes, jobDescription: jd })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || `Server Error ${response.status}`);
                    }

                    // Check if the expected array exists to prevent the .map error
                    if (!data.detailed_analysis) {
                        throw new Error("Invalid response format from AI. Please try again.");
                    }

                    setResults(data);
                } catch (err) {
                    setError(err.message);
                }
                setLoading(false);
            };

            return (
                <div className="container">
                    <h1>ðŸŽ¯ AI Resume Matcher</h1>
                    <p className="subtitle">Analyze your resume against ATS technology counts</p>

                    <div className="card">
                        <label><strong>1. Job Description</strong></label>
                        <textarea 
                            placeholder="Paste the job requirements here..." 
                            value={jd} 
                            onChange={e => setJd(e.target.value)} 
                        />
                        
                        <label style={{display:'block', marginTop:'20px'}}><strong>2. Upload Resumes (PDF or DOCX)</strong></label>
                        <input type="file" multiple accept=".pdf,.docx" onChange={handleFiles} style={{marginTop:'10px'}} />
                        <div className="file-list">
                            {resumes.map((r, i) => <div key={i}>âœ… {r.name}</div>)}
                        </div>

                        <button 
                            className="btn" 
                            style={{marginTop: '2rem'}} 
                            onClick={runAnalysis} 
                            disabled={loading || !jd || resumes.length === 0}
                        >
                            {loading ? "âŒ› Processing..." : "Analyze Best Fit"}
                        </button>
                    </div>

                    {error && (
                        <div className="error-box">
                            <strong>Analysis Failed:</strong> {error}
                            <br/><small>Tip: Check if your GEMINI_API_KEY is set in Vercel settings.</small>
                        </div>
                    )}

                    {results && results.detailed_analysis && (
                        <div>
                            <h2>Match Results</h2>
                            {results.detailed_analysis.map((res, i) => (
                                <div key={i} className="result-card">
                                    <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                        <h3 style={{margin:0}}>{res.resume_name}</h3>
                                        <span className="score">{res.score}% Match</span>
                                    </div>
                                    
                                    <div style={{marginTop:'15px'}}>
                                        <strong>Matching Tech:</strong><br/>
                                        {res.matching_technologies && res.matching_technologies.length > 0 ? (
                                            res.matching_technologies.map((t, j) => <span key={j} className="tag tag-match">{t}</span>)
                                        ) : <span>None found</span>}
                                    </div>

                                    <div style={{marginTop:'15px'}}>
                                        <strong>Missing Keywords:</strong><br/>
                                        {res.missing_keywords && res.missing_keywords.length > 0 ? (
                                            res.missing_keywords.map((t, j) => <span key={j} className="tag tag-missing">{t}</span>)
                                        ) : <span>No major gaps found</span>}
                                    </div>

                                    <div style={{marginTop: '1.5rem', padding: '15px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0'}}>
                                        <strong>ðŸ’¡ ATS Recommendation:</strong><br/>
                                        <span style={{fontSize:'0.95rem'}}>{res.recommendation}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
