<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResumeAI | Modern ATS Optimizer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [jd, setJd] = useState('');
            const [resumes, setResumes] = useState([]);
            const [loading, setLoading] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);

            const extractText = async (file) => {
                const ext = file.name.split('.').pop().toLowerCase();
                try {
                    if (ext === "pdf") {
                        const pdfjsLib = window['pdfjs-dist/build/pdf'];
                        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let text = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + " ";
                        }
                        return text;
                    } else if (ext === "docx") {
                        const arrayBuffer = await file.arrayBuffer();
                        const res = await mammoth.extractRawText({ arrayBuffer });
                        return res.value;
                    }
                    return "Unsupported format";
                } catch (e) { return "Error reading file"; }
            };

            const handleFiles = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setLoading(true);
                const newProcessed = await Promise.all(files.map(async f => ({
                    id: Math.random().toString(36).substr(2, 9),
                    name: f.name,
                    content: await extractText(f)
                })));
                // Sequential Upload: Appending new files to the existing array
                setResumes(prev => [...prev, ...newProcessed]);
                setLoading(false);
                e.target.value = ""; // Reset input
            };

            const analyze = async () => {
                setLoading(true);
                setError(null);
                try {
                    const res = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ resumes, jobDescription: jd })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || "Server error");
                    setResults(data);
                } catch (err) { setError(err.message); }
                setLoading(false);
            };

            return (
                <div className="min-h-screen">
                    <nav className="glass sticky top-0 z-50 px-6 py-4 mb-8 border-b border-slate-200">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">R</div>
                                <span className="text-xl font-bold">Resume<span className="text-indigo-600">AI</span></span>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-5 space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 className="font-semibold mb-4 text-slate-700">1. Target Job Description</h3>
                                <textarea className="w-full h-48 p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500 text-sm" 
                                    placeholder="Paste requirements..." value={jd} onChange={e => setJd(e.target.value)} />
                            </div>

                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h3 className="font-semibold mb-4 text-slate-700">2. Resumes ({resumes.length})</h3>
                                <input type="file" multiple accept=".pdf,.docx" onChange={handleFiles} id="file-in" className="hidden" />
                                <label htmlFor="file-in" className="block w-full border-2 border-dashed border-slate-200 rounded-xl p-6 text-center cursor-pointer hover:bg-slate-50 transition-colors">
                                    <span className="text-sm font-medium text-slate-600">Click to add resumes one-by-one</span>
                                </label>

                                <div className="mt-4 space-y-2 max-h-40 overflow-y-auto">
                                    {resumes.map(r => (
                                        <div key={r.id} className="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100 text-xs">
                                            <span className="truncate flex-1">ðŸ“„ {r.name}</span>
                                            <button onClick={() => setResumes(prev => prev.filter(x => x.id !== r.id))} className="text-rose-500 font-bold ml-2">âœ•</button>
                                        </div>
                                    ))}
                                </div>

                                <button onClick={analyze} disabled={loading || !jd || resumes.length === 0} 
                                    className="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white font-bold py-3 rounded-xl shadow-lg transition-all">
                                    {loading ? "Analyzing..." : "Run ATS Scan"}
                                </button>
                            </div>
                        </div>

                        <div className="lg:col-span-7">
                            {!results && !error && <div className="h-64 flex items-center justify-center border-2 border-dashed border-slate-200 rounded-3xl text-slate-400">Results will appear here</div>}
                            {error && <div className="bg-rose-50 border border-rose-200 text-rose-700 p-4 rounded-xl text-sm">{error}</div>}
                            {results && results.detailed_analysis && (
                                <div className="space-y-6">
                                    {results.detailed_analysis.map((res, i) => (
                                        <div key={i} className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="font-bold text-lg">{res.resume_name}</h3>
                                                <div className={`px-3 py-1 rounded-full font-bold text-sm ${res.score >= 70 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>
                                                    {res.score}% Match
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4 text-xs">
                                                <div>
                                                    <p className="font-bold text-slate-400 uppercase mb-2">Matched Tech</p>
                                                    <div className="flex flex-wrap gap-1">{res.matching_technologies?.map((t,j)=><span key={j} className="bg-emerald-50 text-emerald-700 px-2 py-1 rounded">{t}</span>)}</div>
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-400 uppercase mb-2">Missing</p>
                                                    <div className="flex flex-wrap gap-1">{res.missing_keywords?.map((t,j)=><span key={j} className="bg-rose-50 text-rose-700 px-2 py-1 rounded">{t}</span>)}</div>
                                                </div>
                                            </div>
                                            <div className="mt-4 p-4 bg-slate-50 rounded-lg text-xs leading-relaxed italic text-slate-600">
                                                <strong>AI Advice:</strong> {res.recommendation}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
