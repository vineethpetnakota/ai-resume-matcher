<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Matcher - ATS Pro</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #1e293b; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: var(--card); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); margin-bottom: 2rem; }
        textarea { width: 100%; height: 150px; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin: 1rem 0; font-family: inherit; }
        .btn { background: var(--primary); color: white; border: none; padding: 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: opacity 0.2s; }
        .btn:disabled { opacity: 0.5; }
        .match-score { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; margin: 4px; font-weight: 600; }
        .tag-match { background: #dcfce7; color: #166534; }
        .tag-missing { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        // Use lucideReact global for icons
        const { FileSearch, Upload, CheckCircle, AlertCircle, Loader2 } = lucideReact;

        function App() {
            const [jd, setJd] = useState('');
            const [resumes, setResumes] = useState([]);
            const [loading, setLoading] = useState(false);
            const [results, setResults] = useState(null);

            const extractText = async (file) => {
                if (file.type === "application/pdf") {
                    const pdfjsLib = window['pdfjs-dist/build/pdf'];
                    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjsLib.version}/pdf.worker.min.js`;
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(" ") + " ";
                    }
                    return text;
                } else {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    return result.value;
                }
            };

            const handleFile = async (e) => {
                const files = Array.from(e.target.files);
                const data = await Promise.all(files.map(async f => ({
                    name: f.name,
                    content: await extractText(f)
                })));
                setResumes(data);
            };

            const runAnalysis = async () => {
                setLoading(true);
                try {
                    const res = await fetch('/.netlify/functions/analyze', {
                        method: 'POST',
                        body: JSON.stringify({ resumes, jobDescription: jd })
                    });
                    const data = await res.json();
                    setResults(data);
                } catch (err) {
                    alert("Analysis failed. Ensure your Gemini API Key is set in Netlify.");
                }
                setLoading(false);
            };

            return (
                <div className="container">
                    <header style={{textAlign: 'center', margin: '40px 0'}}>
                        <h1 style={{fontSize: '2.5rem'}}>ðŸŽ¯ AI Resume Matcher</h1>
                        <p>Optimize your resume for ATS technology counts</p>
                    </header>

                    <div className="card">
                        <h3><FileSearch style={{verticalAlign:'middle', marginRight:'8px'}} /> Step 1: Job Description</h3>
                        <textarea placeholder="Paste the job requirements here..." value={jd} onChange={e => setJd(e.target.value)} />
                        
                        <h3><Upload style={{verticalAlign:'middle', marginRight:'8px'}} /> Step 2: Upload Resumes</h3>
                        <input type="file" multiple accept=".pdf,.docx" onChange={handleFile} />
                        
                        <button className="btn" style={{marginTop:'2rem'}} onClick={runAnalysis} disabled={loading || !jd || resumes.length === 0}>
                            {loading ? "Scanning Resumes..." : "Analyze Best Fit"}
                        </button>
                    </div>

                    {results && (
                        <div>
                            <h2>Match Results</h2>
                            {results.detailed_analysis.map((res, i) => (
                                <div key={i} className="card">
                                    <div style={{display:'flex', justifyContent:'space-between'}}>
                                        <h4>{res.resume_name}</h4>
                                        <span className="match-score">{res.score}%</span>
                                    </div>
                                    <p><strong>Technologies Found:</strong> {res.matching_technologies.length}</p>
                                    <div>
                                        {res.matching_technologies.map((t, j) => <span key={j} className="tag tag-match">{t}</span>)}
                                        {res.missing_keywords.map((t, j) => <span key={j} className="tag tag-missing">{t}</span>)}
                                    </div>
                                    <div style={{marginTop: '1rem', padding: '15px', background: '#f1f5f9', borderRadius: '8px'}}>
                                        <strong>ATS Tip:</strong> {res.recommendation}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
